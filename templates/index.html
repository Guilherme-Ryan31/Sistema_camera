<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento Inteligente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>PAINEL DE MONITORAMENTO INTELIGENTE</h1>
            <p class="subtitle">Detecção de Comportamentos Anômalos em Tempo Real</p>
        </header>

        <!-- Controles -->
        <div class="controls">
            <button id="btnIniciar" class="btn btn-success" onclick="iniciarSistema()">
                Iniciar Sistema
            </button>
            <button id="btnParar" class="btn btn-danger" onclick="pararSistema()" disabled>
                Parar Sistema
            </button>
            <button id="btnVerIndice" class="btn btn-info" onclick="abrirModalIndice()">
                Ver Índice
            </button>
        </div>

        <!-- Layout Principal -->
        <div class="main-layout">
            <!-- Coluna Esquerda: Vídeo -->
            <div class="video-section">
                <h2>Vídeo ao Vivo</h2>
                <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="Vídeo ao Vivo">
            </div>

            <!-- Coluna Direita: Alertas e Status -->
            <div class="sidebar">
                <!-- Alertas -->
                <div class="alerts-section">
                    <h2>Alertas</h2>
                    <div id="alertBox" class="alert-box">
                        Nenhuma anomalia detectada
                    </div>
                </div>

                <!-- Última Ação -->
                <div class="prompt-section">
                    <h2>Última Ação Detectada</h2>
                    <div id="promptBox" class="prompt-box">
                        Aguardando atividade...
                    </div>
                </div>

                <!-- Status -->
                <div class="status-section">
                    <div class="status-header">
                        <h2>Status do Sistema</h2>
                        <span id="statusAtivo" class="status-text status-inactive">Desativado</span>
                    </div>
                </div>

                <!-- Gráfico -->
                <div class="chart-section">
                    <h2>Atividade de Eventos</h2>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Galeria de Vídeos -->
        <div class="gallery-section">
            <h2>CLIPES DE ANOMALIAS GRAVADOS</h2>
            <div id="videoGallery" class="video-gallery">
                <p class="no-videos">Nenhum vídeo gravado ainda.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Índice -->
    <div id="modalIndice" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Índice de Sessões</h2>
                <span class="close" onclick="fecharModalIndice()">&times;</span>
            </div>
            <div id="conteudoIndice"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='grafico.js') }}" defer></script>
    <script>
        // Atualiza status a cada segundo
        setInterval(atualizarStatus, 1000);

        // Atualiza galeria e gráfico
        setInterval(atualizarGaleriaEGrafico, 8000);

        // Inicializar gráfico quando a página carregar
        document.addEventListener('DOMContentLoaded', (event) => {
            inicializarGrafico();
            atualizarGaleriaEGrafico();
        });

        function iniciarSistema() {
            fetch('/iniciar_sistema', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('btnIniciar').disabled = true;
                        document.getElementById('btnParar').disabled = false;
                        mostrarNotificacao(data.message, 'success');
                    } else {
                        mostrarNotificacao(data.message, 'error');
                    }
                })
                .catch(error => {
                    mostrarNotificacao('Erro ao iniciar sistema', 'error');
                });
        }

        function pararSistema() {
            fetch('/parar_sistema', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('btnIniciar').disabled = false;
                        document.getElementById('btnParar').disabled = true;
                        mostrarNotificacao(data.message, 'success');
                    } else {
                        mostrarNotificacao(data.message, 'error');
                    }
                })
                .catch(error => {
                    mostrarNotificacao('Erro ao parar sistema', 'error');
                });
        }

        function atualizarStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Status Principal
                    const statusElement = document.getElementById('statusAtivo');
                    if (data.sistema_ativo) {
                        statusElement.textContent = 'Ativado';
                        statusElement.className = 'status-text status-active';
                    } else {
                        statusElement.textContent = 'Desativado';
                        statusElement.className = 'status-text status-inactive';
                    }

                    // Lógica de Alertas e Prompt
                    const alertBox = document.getElementById('alertBox');
                    const promptBox = document.getElementById('promptBox');

                    if (data.ultima_deteccao) {
                        promptBox.innerHTML = `
                            <strong>${data.ultima_deteccao.acao.toUpperCase()}</strong>
                            <br>
                            
                            <br>
                            (${data.ultima_deteccao.timestamp})
                        `;
                        promptBox.className = 'prompt-box prompt-active';

                        if (data.ultima_deteccao.evento) {
                            const evento = data.ultima_deteccao.evento.replace(/_/g, ' ');
                            alertBox.innerHTML = `
                                <div class="alert-warning">
                                    <strong>ALERTA: ${evento.toUpperCase()}!</strong><br>
                                    Ação: ${data.ultima_deteccao.acao}
                                </div>
                            `;
                            alertBox.className = 'alert-box alert-active';
                        } else {
                            alertBox.innerHTML = 'Nenhuma anomalia detectada';
                            alertBox.className = 'alert-box';
                        }
                    } else {
                        alertBox.innerHTML = 'Nenhuma anomalia detectada';
                        alertBox.className = 'alert-box';
                        promptBox.innerHTML = 'Aguardando atividade...';
                        promptBox.className = 'prompt-box';
                    }
                })
                .catch(error => console.error('Erro ao atualizar status:', error));
        }

        function atualizarGaleriaEGrafico() {
            fetch('/videos')
                .then(response => response.json())
                .then(videos => {
                    atualizarGaleria(videos);
                    atualizarGrafico(videos);
                })
                .catch(error => console.error('Erro ao atualizar dados:', error));
        }

        function atualizarGaleria(videos) {
            const gallery = document.getElementById('videoGallery');

            if (videos.length === 0) {
                gallery.innerHTML = '<p class="no-videos">Nenhum vídeo gravado ainda.</p>';
            } else {
                gallery.innerHTML = videos.map(video => `
                    <div class="video-card">
                        <video controls>
                            <source src="/${video.caminho}" type="video/mp4">
                        </video>
                        <p class="video-title">${video.evento}</p>
                        <p class="video-time">${video.timestamp}</p>
                    </div>
                `).join('');
            }
        }

        // ==================== FUNÇÕES DO MODAL DE ÍNDICE ====================

        function abrirModalIndice() {
            fetch('/indices')
                .then(response => response.json())
                .then(indices => {
                    const modal = document.getElementById('modalIndice');
                    const conteudo = document.getElementById('conteudoIndice');

                    if (indices.length === 0) {
                        conteudo.innerHTML = '<div class="sem-dados">Nenhuma sessão gravada ainda.</div>';
                    } else {
                        const sessao = indices[0];

                        let html = `
                            <div class="sessao-info">
                                <h3>${sessao.video_sessao}</h3>
                                <p><strong>Início:</strong> ${sessao.inicio}</p>
                                <p><strong>Duração:</strong> ${formatarSegundos(sessao.duracao)}</p>
                                <p><strong>Anomalias:</strong> ${sessao.total_anomalias}</p>
                                <a href="/videos_sessoes/${sessao.video_sessao}" download style="color: #4444ff; text-decoration: underline;">Baixar Vídeo Completo</a>
                            </div>
                        `;

                        if (sessao.anomalias && sessao.anomalias.length > 0) {
                            html += '<h3 style="color: #F5C742; margin: 20px 0 10px 0;">Anomalias Detectadas (clique para copiar timestamp):</h3>';
                            html += '<div class="anomalias-lista">';

                            sessao.anomalias.forEach((anomalia, i) => {
                                html += `
                                    <div class="anomalia-item" onclick="copiarTimestamp('${anomalia.tempo_no_video_formatado}')">
                                        <strong>#${i + 1}</strong>
                                        <span style="color: #00ff41; font-weight: bold; margin: 0 10px;">${anomalia.tempo_no_video_formatado}</span>
                                        <span style="color: #ff4444; text-transform: uppercase;">${anomalia.tipo.replace(/_/g, ' ')}</span>
                                        <br>
                                        <span style="color: #B0B0B0; font-size: 0.85rem;">Clip: ${anomalia.clip_associado}</span>
                                    </div>
                                `;
                            });

                            html += '</div>';
                        }

                        conteudo.innerHTML = html;
                    }

                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Erro ao carregar índices:', error);
                    mostrarNotificacao('Erro ao carregar índices', 'error');
                });
        }

        function fecharModalIndice() {
            document.getElementById('modalIndice').style.display = 'none';
        }

        function copiarTimestamp(timestamp) {
            navigator.clipboard.writeText(timestamp).then(() => {
                mostrarNotificacao('Timestamp copiado: ' + timestamp, 'success');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
            });
        }

        function formatarSegundos(segundos) {
            const h = Math.floor(segundos / 3600);
            const m = Math.floor((segundos % 3600) / 60);
            const s = Math.floor(segundos % 60);
            return `${h}h ${m}m ${s}s`;
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalIndice');
            if (event.target == modal) {
                fecharModalIndice();
            }
        }

        function mostrarNotificacao(mensagem, tipo) {
            const notif = document.createElement('div');
            notif.className = `notification notification-${tipo}`;
            notif.textContent = mensagem;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>